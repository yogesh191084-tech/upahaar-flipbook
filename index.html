<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upahaar - Flipbook</title>
<style>
  :root { --bg:#f2efe9; --card:#fff; --muted:#6b6b6b; --accent:#0b6b3a; --accent-dark:#0a5a31; }
  html,body { height:100%; margin:0; font-family:Inter, system-ui, Arial, sans-serif; background:var(--bg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; box-sizing:border-box; }
  .viewer { width:92vw; max-width:1100px; height:88vh; max-height:820px; background:var(--card); box-shadow:0 18px 50px rgba(0,0,0,0.12); border-radius:12px; overflow:hidden; position:relative; }
  .page { width:100%; height:100%; display:flex; align-items:center; justify-content:center; transition: transform 0.5s cubic-bezier(.2,.9,.2,1), opacity 0.45s ease; position:absolute; top:0; left:0; pointer-events:none; background:#fff; }
  .page img { max-width:100%; max-height:100%; display:block; border-radius:6px; user-select:none; }
  .controls { position:absolute; bottom:14px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:99; }
  .controls button { background:var(--accent-dark); color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-size:14px; }
  .controls button:disabled { opacity:0.35; cursor:default; }
  .counter { position:absolute; top:12px; right:12px; background:rgba(0,0,0,0.6); color:#fff; padding:6px 10px; border-radius:6px; font-size:13px; z-index:99; }
  .sound-toggle { position:absolute; top:12px; left:12px; z-index:99; }
  .sound-toggle button { background:transparent; color:var(--accent-dark); border:1px solid #ddd; padding:6px 10px; border-radius:6px; font-size:13px; cursor:pointer; }
  .share { position:absolute; top:12px; left:120px; display:flex; gap:8px; z-index:99; }
  .share button { background:transparent; color:var(--accent-dark); border:1px solid #ddd; padding:6px 10px; border-radius:6px; font-size:13px; cursor:pointer; }
  .note { position:absolute; bottom:14px; right:14px; font-size:12px; color:var(--muted); z-index:99; }
  .cover { position:absolute; inset:0; background:linear-gradient(180deg,#f7fbf8,#f2efe9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; }
  .cover h1 { font-size:28px; margin:0 0 12px; color:var(--accent-dark); }
  .cover p { margin:6px 0 18px; color:var(--muted); }
  .cover button { background:var(--accent); color:#fff; padding:12px 20px; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
  @media (max-width:700px) {
    .viewer { width:98vw; height:92vh; }
    .share { left:90px; }
    .cover h1 { font-size:20px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="viewer" id="viewer" aria-live="polite">
    <div class="sound-toggle"><button id="soundBtn">üéµ Sound: ON</button></div>

    <div class="share">
      <button id="shareWhats">WhatsApp</button>
      <button id="shareLinked">LinkedIn</button>
      <button id="shareEmail">Email</button>
    </div>

    <div class="counter" id="counter">0 / 0</div>

    <div class="controls" id="controls">
      <button id="prevBtn">‚óÄ Prev</button>
      <button id="nextBtn">Next ‚ñ∂</button>
    </div>

    <div class="note">Use ‚Üê ‚Üí keys to flip. Click Start to enable music.</div>

    <div class="cover" id="cover" role="dialog" aria-label="Upahaar cover">
      <h1>Upahaar ‚Äî Corporate Gifting</h1>
      <p>Interactive catalogue ‚Äî click Start to explore (gentle ambient music plays)</p>
      <button id="startBtn">Start Flipbook ‚ñ∂</button>
    </div>

  </div>
</div>

<script>
/*
  Full flipbook + synthesized rhythmic ambient music:
  - Uses WebAudio only (no external samples)
  - Music starts after Start click (user gesture)
  - Rhythm: soft sub-thump + light percussive clicks + melodic pad layers
  - Volume set higher so it's clearly audible but still smooth
  - Pages: 80 (page_001..page_080)
*/

(function(){
  // DOM
  const viewer = document.getElementById('viewer');
  const counter = document.getElementById('counter');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const soundBtn = document.getElementById('soundBtn');
  const shareWhats = document.getElementById('shareWhats');
  const shareLinked = document.getElementById('shareLinked');
  const shareEmail = document.getElementById('shareEmail');
  const cover = document.getElementById('cover');
  const startBtn = document.getElementById('startBtn');

  // pages
  const totalPages = 80;
  const pad = n => String(n).padStart(3, '0');

  // audio state
  let audioCtx = null;
  let masterGain = null;
  let musicNodes = null; // keep refs
  let soundOn = true;

  // ensure and start audio graph
  function ensureAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // master gain (overall level)
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 1.0; // we're controlling voice levels individually (safe to keep at 1)
    masterGain.connect(audioCtx.destination);

    // --- rhythmic low thump (sub) ---
    // create an oscillator + envelope triggered on interval
    const subOsc = audioCtx.createOscillator();
    subOsc.type = 'sine';
    subOsc.frequency.value = 60; // deep sub
    const subGain = audioCtx.createGain();
    subGain.gain.value = 0.0001;
    subOsc.connect(subGain).connect(masterGain);
    subOsc.start();

    // --- soft percussive click (high transient) ---
    // We'll synthesize a short filtered noise burst when needed
    function playClick(time) {
      // noise buffer
      const bufferSize = audioCtx.sampleRate * 0.04; // 40ms
      const nb = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
      const data = nb.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-6 * i / bufferSize);

      const src = audioCtx.createBufferSource();
      src.buffer = nb;
      const filt = audioCtx.createBiquadFilter();
      filt.type = 'highpass';
      filt.frequency.value = 800;
      const g = audioCtx.createGain();
      g.gain.setValueAtTime(0.06, time || audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.0001, (time || audioCtx.currentTime) + 0.08);
      src.connect(filt).connect(g).connect(masterGain);
      src.start(time || audioCtx.currentTime);
      src.stop((time || audioCtx.currentTime) + 0.09);
    }

    // --- melodic pad layers (warm, slightly detuned) ---
    const padOsc1 = audioCtx.createOscillator();
    padOsc1.type = 'sine'; padOsc1.frequency.value = 110; // base
    const padGain1 = audioCtx.createGain(); padGain1.gain.value = 0.02;

    const padOsc2 = audioCtx.createOscillator();
    padOsc2.type = 'triangle'; padOsc2.frequency.value = 110 * 1.002; // tiny detune
    const padGain2 = audioCtx.createGain(); padGain2.gain.value = 0.015;

    const padFilter = audioCtx.createBiquadFilter();
    padFilter.type = 'lowpass'; padFilter.frequency.value = 900;

    padOsc1.connect(padGain1); padOsc2.connect(padGain2);
    padGain1.connect(padFilter); padGain2.connect(padFilter);
    padFilter.connect(masterGain);

    padOsc1.start();
    padOsc2.start();

    // --- melodic bell/soft flute voice (warm bell-ish) ---
    function scheduleBell(freq, t, dur = 1.4, vol = 0.06) {
      const o = audioCtx.createOscillator(); o.type = 'sine';
      const grd = audioCtx.createGain();
      const bf = audioCtx.createBiquadFilter(); bf.type = 'bandpass'; bf.Q = 5; bf.frequency.value = freq * 1.0;
      grd.gain.setValueAtTime(0.0001, t);
      grd.gain.linearRampToValueAtTime(vol, t + 0.03);
      grd.gain.exponentialRampToValueAtTime(0.0001, t + dur);
      o.frequency.setValueAtTime(freq, t);
      o.connect(bf).connect(grd).connect(masterGain);
      o.start(t); o.stop(t + dur + 0.05);
    }

    // rhythmic engine: tempo + scheduled events
    const bpm = 62; // calm tempo ‚Äî adjustable
    const beatMs = 60000 / bpm;
    const subdivision = 2; // two pulses per beat
    const stepMs = beatMs / subdivision;

    // schedule repeating pattern: sub-thump + clicks + bells
    let startTime = audioCtx.currentTime + 0.1;
    function scheduleLoop() {
      // schedule a few seconds ahead to be safe
      const lookAheadSec = 6.0;
      const now = audioCtx.currentTime;
      while (startTime < now + lookAheadSec) {
        // sub thump (short envelope)
        subGain.gain.cancelScheduledValues(startTime);
        subGain.gain.setValueAtTime(0.0001, startTime);
        subGain.gain.linearRampToValueAtTime(0.6, startTime + 0.006); // quick attack
        subGain.gain.exponentialRampToValueAtTime(0.0001, startTime + 0.32); // decay

        // soft click slightly after the thump
        playClick(startTime + 0.06);

        // occasional bell on some measures
        const measureLen = beatMs * 4 / 1000; // seconds for 4/4 bar
        const beatNumber = Math.floor((startTime - audioCtx.currentTime) / (beatMs / 1000)) % 8;
        if (beatNumber === 0) {
          scheduleBell(660, startTime + 0.18, 1.2, 0.045);
        } else if (beatNumber === 3) {
          scheduleBell(520, startTime + 0.18, 1.1, 0.038);
        }

        startTime += stepMs / 1000.0; // advance (converted to seconds)
      }
    }

    // start scheduling loop with interval
    scheduleLoop();
    const schedulerId = setInterval(scheduleLoop, 1200);

    // Save nodes for control
    musicNodes = {
      audioCtx, masterGain, subOsc, subGain: subGain,
      padOsc1, padOsc2, padGain1, padGain2, padFilter,
      scheduleLoop, schedulerId
    };
  }

  // stop music (if needed)
  function stopMusic() {
    if (!musicNodes) return;
    try {
      clearInterval(musicNodes.schedulerId);
      // gently lower master
      musicNodes.masterGain.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + 0.8);
    } catch (e) { console.log(e); }
  }

  function playFlipChime() {
    if (!audioCtx || !soundOn) return;
    try {
      const ctx = audioCtx;
      const now = ctx.currentTime;
      const o = ctx.createOscillator(); o.type = 'triangle'; o.frequency.value = 900;
      const g = ctx.createGain(); g.gain.setValueAtTime(0.09, now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.45);
      o.connect(g).connect(masterGain);
      o.start(now); o.stop(now + 0.5);
    } catch (e) { console.log(e); }
  }

  // Sound toggle
  soundBtn.addEventListener('click', () => {
    if (!audioCtx) {
      // if toggled before Start, just prepare audio (but not start scheduling until Start)
      try { ensureAudio(); } catch (e) { console.log(e); }
    }
    soundOn = !soundOn;
    if (!musicNodes || !musicNodes.masterGain) {
      // set masterGain directly if exists
      if (masterGain) {
        masterGain.gain.linearRampToValueAtTime(soundOn ? 1.0 : 0.0001, audioCtx.currentTime + 0.6);
      }
    } else {
      // scale master (we used gain 1.0 as base)
      masterGain.gain.linearRampToValueAtTime(soundOn ? 1.0 : 0.0001, audioCtx.currentTime + 0.6);
    }
    soundBtn.textContent = soundOn ? 'üéµ Sound: ON' : 'üîá Sound: OFF';
  });

  // --- Pages: create elements and navigation ---
  function initPages() {
    for (let i = 1; i <= totalPages; i++) {
      const src = `pages/page_${pad(i)}.png`;
      const el = document.createElement('div');
      el.className = 'page';
      el.dataset.idx = i - 1;
      el.style.zIndex = 100 + (totalPages - i);
      const img = document.createElement('img');
      img.src = src;
      img.alt = 'Page ' + i;
      el.appendChild(img);
      viewer.appendChild(el);
    }

    const pages = Array.from(document.querySelectorAll('.page'));
    let current = 0;

    function updateUI(doSound = true) {
      pages.forEach((p, i) => {
        p.style.zIndex = (i === current) ? 999 : (100 + (pages.length - i));
        if (i < current) { p.style.transform = 'translateX(-130%)'; p.style.opacity = '0'; p.style.pointerEvents = 'none'; }
        else if (i === current) { p.style.transform = 'translateX(0)'; p.style.opacity = '1'; p.style.pointerEvents = 'auto'; }
        else { p.style.transform = 'translateX(130%)'; p.style.opacity = '0'; p.style.pointerEvents = 'none'; }
      });
      counter.textContent = (current + 1) + ' / ' + pages.length;
      prevBtn.disabled = current === 0;
      nextBtn.disabled = current === pages.length - 1;
      if (doSound) playFlipChime();
      window.current = current;
    }

    window.showPage = function (n) {
      current = Math.max(0, Math.min(pages.length - 1, n));
      updateUI(true);
    };

    prevBtn.onclick = () => showPage((window.current || 0) - 1);
    nextBtn.onclick = () => showPage((window.current || 0) + 1);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') showPage((window.current || 0) - 1);
      if (e.key === 'ArrowRight') showPage((window.current || 0) + 1);
    });

    // deep-link support
    const pParam = parseInt(new URLSearchParams(window.location.search).get('p') || '0', 10);
    if (!isNaN(pParam) && pParam > 0 && pParam <= pages.length) {
      current = Math.max(0, Math.min(pages.length - 1, pParam - 1));
    }
    updateUI(false);
  }

  // Start button: initialize audio and pages
  startBtn.addEventListener('click', async () => {
    try {
      ensureAudio();
      // resume (force) - required in many browsers
      await audioCtx.resume();
      // set master to audible level
      if (masterGain) masterGain.gain.setValueAtTime(1.0, audioCtx.currentTime);
    } catch (e) { console.log('audio resume error', e); }

    cover.style.display = 'none';
    initPages();
  });

  // Share buttons (deep-link current page)
  function shareUrlWithPage() {
    const base = window.location.href.split('?')[0];
    const p = (typeof window.current === 'number') ? (window.current + 1) : 1;
    return base + '?p=' + p;
  }
  shareWhats.addEventListener('click', () => {
    const url = shareUrlWithPage();
    window.open('https://api.whatsapp.com/send?text=' + encodeURIComponent('Flip through Upahaar catalogue: ' + url), '_blank');
  });
  shareLinked.addEventListener('click', () => {
    const url = shareUrlWithPage();
    window.open('https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(url), '_blank');
  });
  shareEmail.addEventListener('click', () => {
    const url = shareUrlWithPage();
    window.location.href = 'mailto:?subject=' + encodeURIComponent('Upahaar Catalogue') + '&body=' + encodeURIComponent('Hi ‚Äî check this Upahaar catalogue: ' + url);
  });

})();
</script>
</body>
</html>
