<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upahaar - Flipbook</title>
<style>
  :root { --bg:#f2efe9; --card:#fff; --muted:#6b6b6b; --accent:#222; }
  html,body { height:100%; margin:0; font-family:Inter, system-ui, Arial, sans-serif; background:var(--bg); }
  .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; box-sizing:border-box; }
  .viewer { width:92vw; max-width:1100px; height:88vh; max-height:820px; background:var(--card); box-shadow:0 18px 50px rgba(0,0,0,0.12); border-radius:12px; overflow:hidden; position:relative; }
  .page { width:100%; height:100%; display:flex; align-items:center; justify-content:center; transition: transform 0.5s cubic-bezier(.2,.9,.2,1), opacity 0.45s ease; backface-visibility:hidden; position:absolute; top:0; left:0; will-change: transform, opacity; pointer-events:none; background:#fff; }
  .page img { max-width:100%; max-height:100%; display:block; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.06); user-select:none; pointer-events:none; }
  .controls { position:absolute; bottom:14px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:99999; }
  .controls button { background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-size:14px; opacity:.96; }
  .controls button:disabled { opacity:0.35; cursor:default; }
  .counter { position:absolute; top:12px; right:12px; background:rgba(0,0,0,0.6); color:#fff; padding:6px 10px; border-radius:6px; font-size:13px; z-index:99999; }
  .sound-toggle { position:absolute; top:12px; left:12px; z-index:99999; }
  .sound-toggle button { background:transparent; color:var(--accent); border:1px solid #ddd; padding:6px 10px; border-radius:6px; font-size:13px; cursor:pointer; }
  .note { position:absolute; bottom:14px; right:14px; font-size:12px; color:var(--muted); z-index:99999; }
  .fallback { padding:20px; text-align:center; color:var(--muted); }
  .cover { position:absolute; top:0; left:0; right:0; bottom:0; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10000; }
  .cover h1 { font-size:24px; margin-bottom:16px; }
  .cover button { background:var(--accent); color:#fff; padding:12px 20px; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
</style>
</head>
<body>
<div class="wrap">
  <div class="viewer" id="viewer" aria-live="polite">
    <div class="sound-toggle"><button id="soundBtn">üéµ Sound: ON</button></div>
    <div class="counter" id="counter">0 / 0</div>
    <div class="controls" id="controls">
      <button id="prevBtn">‚óÄ Prev</button>
      <button id="nextBtn">Next ‚ñ∂</button>
    </div>
    <div class="note">Use ‚Üê ‚Üí keys to flip</div>
    <div class="cover" id="cover">
      <h1>Welcome to Upahaar Flipbook</h1>
      <button id="startBtn">Start Flipbook</button>
    </div>
  </div>
</div>

<script>
(function(){
  const viewer = document.getElementById('viewer');
  const counter = document.getElementById('counter');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const soundBtn = document.getElementById('soundBtn');
  const cover = document.getElementById('cover');
  const startBtn = document.getElementById('startBtn');

  const maxPagesProbe = 120;
  const pad = n => String(n).padStart(3,'0');

  function probePages(maxN=120) {
    return new Promise((resolve) => {
      const found = [];
      let checked = 0;
      for (let i=1; i<=maxN; i++){
        const name = `pages/page_${pad(i)}.png`;
        const img = new Image();
        img.onload = ()=>{ found.push(name); done(); };
        img.onerror = ()=>{ done(); };
        img.src = name + '?_=' + Date.now() + Math.floor(Math.random()*1000);
      }
      function done(){ checked++; if (checked>=maxN) resolve(found); }
    });
  }

  let audioCtx=null, masterGain=null, soundOn=true;

  function ensureAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.15; // ambient volume
    masterGain.connect(audioCtx.destination);

    // Ambient pad (continuous background)
    const o1 = audioCtx.createOscillator();
    const o2 = audioCtx.createOscillator();
    o1.type='sine'; o2.type='sine';
    o1.frequency.value=220; o2.frequency.value=221;
    const g1 = audioCtx.createGain(); const g2 = audioCtx.createGain();
    g1.gain.value=0.05; g2.gain.value=0.045;
    const filter = audioCtx.createBiquadFilter();
    filter.type='lowpass'; filter.frequency.value=800;
    const lfo = audioCtx.createOscillator(); const lfoGain = audioCtx.createGain();
    lfo.type='sine'; lfo.frequency.value=0.03; lfoGain.gain.value=280;
    lfo.connect(lfoGain); lfoGain.connect(filter.frequency);

    o1.connect(g1); g1.connect(filter);
    o2.connect(g2); g2.connect(filter);
    filter.connect(masterGain);

    o1.start(); o2.start(); lfo.start();
  }

  function playChime(){
    if(!soundOn || !audioCtx) return;
    try{
      const ctx=audioCtx;
      const osc=ctx.createOscillator(); const g=ctx.createGain();
      osc.type='triangle'; osc.frequency.value=880;
      g.gain.setValueAtTime(0.08,ctx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.4);
      osc.connect(g).connect(masterGain);
      osc.start(); osc.stop(ctx.currentTime+0.5);
    }catch(e){console.log(e);}
  }

  soundBtn.addEventListener('click',()=>{
    if(!audioCtx){ensureAudio();}
    soundOn=!soundOn;
    if(!masterGain) return;
    if(!soundOn){
      masterGain.gain.linearRampToValueAtTime(0.0001,audioCtx.currentTime+0.5);
      soundBtn.textContent='üîá Sound: OFF';
    }else{
      masterGain.gain.linearRampToValueAtTime(0.15,audioCtx.currentTime+0.8);
      soundBtn.textContent='üéµ Sound: ON';
    }
  });

  async function init(){
    const images=await probePages(maxPagesProbe);
    if(!images.length){
      viewer.innerHTML='<div class="fallback">No pages found in <code>pages/</code></div>';
      return;
    }
    images.forEach((src,i)=>{
      const el=document.createElement('div');
      el.className='page'; el.dataset.idx=i; el.style.zIndex=100+(images.length-i);
      const img=document.createElement('img'); img.src=src; img.alt='Page '+(i+1);
      el.appendChild(img); viewer.appendChild(el);
    });
    const pages=Array.from(document.querySelectorAll('.page'));
    let current=0;
    function updateUI(playSound=true){
      pages.forEach((p,i)=>{
        p.style.zIndex=(i===current)?999:(100+(pages.length-i));
        if(i<current){p.style.transform='translateX(-130%)';p.style.opacity='0';}
        else if(i===current){p.style.transform='translateX(0)';p.style.opacity='1';}
        else{p.style.transform='translateX(130%)';p.style.opacity='0';}
      });
      counter.textContent=(current+1)+' / '+pages.length;
      prevBtn.disabled=current===0; nextBtn.disabled=current===pages.length-1;
      if(playSound) playChime();
      window.current=current;
    }
    window.showPage=n=>{current=Math.max(0,Math.min(pages.length-1,n));updateUI(true);};
    prevBtn.onclick=()=>showPage((window.current||0)-1);
    nextBtn.onclick=()=>showPage((window.current||0)+1);
    document.addEventListener('keydown',e=>{
      if(e.key==='ArrowLeft') showPage((window.current||0)-1);
      if(e.key==='ArrowRight') showPage((window.current||0)+1);
    });
    updateUI(false);
  }

  startBtn.addEventListener('click',()=>{
    ensureAudio();
    cover.style.display='none';
    init();
  });
})();
</script>
</body>
</html>
