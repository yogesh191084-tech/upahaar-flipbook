<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upahaar - Flipbook</title>
<style>
  :root { --bg:#f2efe9; --card:#fff; --muted:#6b6b6b; --accent:#222; }
  html,body { height:100%; margin:0; font-family:Inter, system-ui, Arial, sans-serif; background:var(--bg); }
  .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; box-sizing:border-box; }
  .viewer { width:92vw; max-width:1100px; height:88vh; max-height:820px; background:var(--card); box-shadow:0 18px 50px rgba(0,0,0,0.12); border-radius:12px; overflow:hidden; position:relative; }
  .page { width:100%; height:100%; display:flex; align-items:center; justify-content:center; transition: transform 0.5s cubic-bezier(.2,.9,.2,1), opacity 0.45s ease; backface-visibility:hidden; position:absolute; top:0; left:0; will-change: transform, opacity; pointer-events:none; background:#fff; }
  .page img { max-width:100%; max-height:100%; display:block; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,0.06); user-select:none; pointer-events:none; }
  .controls { position:absolute; bottom:14px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:99999; }
  .controls button { background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-size:14px; opacity:.96; }
  .controls button:disabled { opacity:0.35; cursor:default; }
  .counter { position:absolute; top:12px; right:12px; background:rgba(0,0,0,0.6); color:#fff; padding:6px 10px; border-radius:6px; font-size:13px; z-index:99999; }
  .sound-toggle { position:absolute; top:12px; left:12px; display:flex; gap:8px; align-items:center; z-index:99999; }
  .sound-toggle button { background:transparent; color:var(--accent); border:1px solid #ddd; padding:6px 10px; border-radius:6px; font-size:13px; cursor:pointer; }
  .share { position:absolute; top:12px; left:150px; display:flex; gap:8px; align-items:center; z-index:99999; }
  .share button { background:transparent; color:var(--accent); border:1px solid #ddd; padding:6px 10px; border-radius:6px; font-size:13px; cursor:pointer; }
  .note { position:absolute; bottom:14px; right:14px; font-size:12px; color:var(--muted); z-index:99999; }
  .fallback { padding:20px; text-align:center; color:var(--muted); }

  /* cover overlay */
  .cover {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    background: linear-gradient(rgba(255,255,255,0.75), rgba(255,255,255,0.65));
    z-index: 999999;
  }
  .cover-card {
    text-align: center;
    padding: 28px 34px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
    background: white;
    max-width: 720px;
  }
  .cover-card h1 { margin:0 0 8px; font-size:34px; color:var(--accent); }
  .cover-sub { margin:0 0 16px; color:var(--muted); }
  .cover-card button {
    background:var(--accent); color:#fff; border:none; padding:10px 18px; border-radius:8px; cursor:pointer; font-size:16px;
  }
  .cover-small { margin-top:12px; font-size:12px; color:var(--muted); }

  @media (max-width:700px) {
    .viewer { width:98vw; height:92vh; }
    .controls button { padding:8px 10px; font-size:13px; }
    .cover-card{ padding:18px; }
    .cover-card h1{ font-size:22px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="viewer" id="viewer" aria-live="polite">
    <div class="sound-toggle"><button id="soundBtn">üîä Sound: ON</button></div>
    <div class="share">
      <button id="shareWhats">WhatsApp</button>
      <button id="shareLinked">LinkedIn</button>
      <button id="shareEmail">Email</button>
    </div>
    <div class="counter" id="counter">0 / 0</div>

    <!-- cover / title overlay -->
    <div class="cover" id="cover" role="dialog" aria-label="Upahaar catalogue cover">
      <div class="cover-card">
        <h1>Upahaar</h1>
        <p class="cover-sub">Corporate gifting solutions ‚Äî product catalogue</p>
        <button id="startBtn">Start flipping ‚ñ∂</button>
        <p class="cover-small">Use ‚Üê ‚Üí keys to flip after starting</p>
      </div>
    </div>

    <!-- pages will be injected here by script -->
    <div class="controls" id="controls">
      <button id="prevBtn">‚óÄ Prev</button>
      <button id="nextBtn">Next ‚ñ∂</button>
    </div>
    <div class="note">Use ‚Üê ‚Üí keys to flip. Click once to enable sound on some browsers.</div>
  </div>
</div>

<script>
/*
  Robust flipbook index.html
  - dynamically discovers page_001..page_120 in pages/
  - avoids overlap by moving non-current pages off-screen
  - wired Prev/Next and keyboard
  - WebAudio page-turn sound with toggle
  - share buttons (WhatsApp, LinkedIn, Email)
  - cover overlay + deep-link via ?p=<n>
*/

(function(){
  const viewer = document.getElementById('viewer');
  const counter = document.getElementById('counter');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const soundBtn = document.getElementById('soundBtn');
  const shareWhats = document.getElementById('shareWhats');
  const shareLinked = document.getElementById('shareLinked');
  const shareEmail = document.getElementById('shareEmail');

  // try loading sequential page_###.png images up to maxPages
  const maxPagesProbe = 120;
  const pad = n => String(n).padStart(3, '0');

  function probePages(maxN=120) {
    return new Promise((resolve) => {
      const found = [];
      let checked = 0;
      // We will consider probing complete when we've attempted maxN images.
      for (let i=1; i<=maxN; i++){
        const name = `pages/page_${pad(i)}.png`;
        const img = new Image();
        img.onload = function(){ found.push({name}); done(); };
        img.onerror = function(){ done(); };
        img.src = name + '?_=' + Date.now() + Math.floor(Math.random()*1000); // cache buster
      }
      function done(){
        checked++;
        if (checked >= maxN) resolve(found.map(x=>x.name));
      }
    });
  }

  async function init(){
    const images = await probePages(maxPagesProbe);
    if (!images || images.length === 0){
      viewer.innerHTML = '<div class="fallback"><h3>No pages found</h3><p>Make sure there is a <code>pages/</code> folder next to this file containing page_###.png files.</p></div>';
      return;
    }

    // Create page elements
    images.forEach((src, i)=>{
      const el = document.createElement('div');
      el.className = 'page';
      el.dataset.idx = i;
      el.style.zIndex = 100 + (images.length - i);
      const img = document.createElement('img');
      img.src = src;
      img.alt = 'Page ' + (i+1);
      el.appendChild(img);
      viewer.appendChild(el);
    });

    const pages = Array.from(document.querySelectorAll('.page'));
    let current = 0;
    let soundOn = true;
    let audioCtx = null;

    function playFlipSound(){
      if(!soundOn) return;
      try{
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const ctx = audioCtx;
        const now = ctx.currentTime;
        const duration = 0.22;
        const bufferSize = Math.floor(ctx.sampleRate * duration);
        const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
        const data = buffer.getChannelData(0);
        for(let i=0;i<bufferSize;i++) data[i] = (Math.random()*2-1) * Math.exp(-5*i/bufferSize);
        const noise = ctx.createBufferSource();
        noise.buffer = buffer;
        const noiseFilter = ctx.createBiquadFilter();
        noiseFilter.type = 'lowpass';
        noiseFilter.frequency.setValueAtTime(1400, now);
        const noiseGain = ctx.createGain();
        noiseGain.gain.setValueAtTime(0.6, now);
        noiseGain.gain.exponentialRampToValueAtTime(0.001, now + duration*0.9);
        noise.connect(noiseFilter).connect(noiseGain).connect(ctx.destination);
        noise.start(now);
        noise.stop(now + duration);

        const osc = ctx.createOscillator();
        const g = ctx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(900, now);
        g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.12, now + 0.006);
        g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
        osc.connect(g).connect(ctx.destination);
        osc.start(now);
        osc.stop(now + duration);
      }catch(e){
        // fail silently if audio blocked
        console.log('audio err', e);
      }
    }

    // New updateUI: non-current pages moved off-screen (no overlap)
    function updateUI(playSound=true){
      pages.forEach((p,i)=>{
        // set stacking order
        p.style.zIndex = (i === current) ? 999 : (100 + (pages.length - i));
        if(i < current) {
          p.style.transform = 'translateX(-130%) rotateY(-12deg) scale(.98)';
          p.style.opacity = '0';
          p.style.pointerEvents = 'none';
        }
        else if(i === current) {
          p.style.transform = 'translateX(0) rotateY(0deg) scale(1)';
          p.style.opacity = '1';
          p.style.pointerEvents = 'auto';
        }
        else {
          p.style.transform = 'translateX(130%) rotateY(0deg) scale(.98)';
          p.style.opacity = '0';
          p.style.pointerEvents = 'none';
        }
      });
      counter.textContent = (current+1) + ' / ' + pages.length;
      prevBtn.disabled = current === 0;
      nextBtn.disabled = current === pages.length-1;
      if(playSound) playFlipSound();
      // expose current for console debugging
      window.current = current;
    }

    // safe showPage wrapper
    window.showPage = function(n){
      current = Math.max(0, Math.min(pages.length - 1, n));
      updateUI(true);
    };

    // attach navigation handlers (use onclick for reliability)
    prevBtn.onclick = ()=> showPage((window.current||0)-1);
    nextBtn.onclick = ()=> showPage((window.current||0)+1);

    // keyboard navigation
    document.addEventListener('keydown', (e)=>{
      if(e.key === 'ArrowLeft') showPage((window.current||0)-1);
      if(e.key === 'ArrowRight') showPage((window.current||0)+1);
    });

    // sound toggle button
    soundBtn.addEventListener('click', ()=>{
      soundOn = !soundOn;
      soundBtn.textContent = soundOn ? 'üîä Sound: ON' : 'üîá Sound: OFF';
      if(soundOn && audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
    });

    // share handlers (will include page param)
    const pageUrl = window.location.href;
    shareWhats.addEventListener('click', ()=>{
      const pageNum = (typeof window.current === 'number' ? (window.current + 1) : 1);
      const txt = encodeURIComponent('Flip through Upahaar catalogue: ' + (pageUrl.split('?')[0] + '?p=' + pageNum));
      window.open('https://wa.me/?text=' + txt, '_blank');
    });
    shareLinked.addEventListener('click', ()=>{
      const pageNum = (typeof window.current === 'number' ? (window.current + 1) : 1);
      window.open('https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(pageUrl.split('?')[0] + '?p=' + pageNum), '_blank');
    });
    shareEmail.addEventListener('click', ()=>{
      const pageNum = (typeof window.current === 'number' ? (window.current + 1) : 1);
      const subj = encodeURIComponent('Upahaar Catalogue');
      const body = encodeURIComponent('Hi, take a flip through this Upahaar catalogue: ' + (pageUrl.split('?')[0] + '?p=' + pageNum));
      window.location.href = 'mailto:?subject=' + subj + '&body=' + body;
    });

    // initialize (no sound play on first paint)
    updateUI(false);

    // --- cover + deep-link support ---
    const cover = document.getElementById('cover');
    const startBtn = document.getElementById('startBtn');

    // read URL param ?p= (1-based page). If present, convert to zero-based index.
    const urlParams = new URLSearchParams(window.location.search);
    const pParam = parseInt(urlParams.get('p') || '0', 10);
    if (!isNaN(pParam) && pParam > 0 && pParam <= pages.length) {
      // user asked to open a specific page; hide cover and jump
      cover.style.display = 'none';
      current = Math.max(0, Math.min(pages.length - 1, pParam - 1));
      updateUI(false);
    } else {
      // show cover initially (user must click Start)
      cover.style.display = 'flex';
    }

    startBtn.addEventListener('click', ()=>{
      cover.style.display = 'none';
      // show first page if not already set
      if(typeof window.current === 'undefined' || window.current === null) current = 0;
      updateUI(false);
    });

    // expose pages length for debugging
    window.totalPages = pages.length;

    // hint: clicking viewer may unlock audio on some browsers
    viewer.addEventListener('click', ()=>{ if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); });

  } // end init

  // run initialization
  init();

})();
</script>
</body>
</html>
