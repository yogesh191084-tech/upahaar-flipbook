<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upahaar - Flipbook</title>
<style>
  :root { --bg:#f2efe9; --card:#fff; --muted:#6b6b6b; --accent:#0b6b3a; --accent-dark:#0a5a31; }
  html,body { height:100%; margin:0; font-family:Inter, system-ui, Arial, sans-serif; background:var(--bg); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
  .wrap { min-height:100vh; display:flex; align-items:center; justify-content:center; padding:28px; box-sizing:border-box; }
  .viewer { width:92vw; max-width:1100px; height:88vh; max-height:820px; background:var(--card); box-shadow:0 18px 50px rgba(0,0,0,0.12); border-radius:12px; overflow:hidden; position:relative; }
  .page { width:100%; height:100%; display:flex; align-items:center; justify-content:center; transition: transform 0.5s cubic-bezier(.2,.9,.2,1), opacity 0.45s ease; position:absolute; top:0; left:0; pointer-events:none; background:#fff; }
  .page img { max-width:100%; max-height:100%; display:block; border-radius:6px; user-select:none; }
  .controls { position:absolute; bottom:14px; left:50%; transform:translateX(-50%); display:flex; gap:10px; z-index:99; }
  .controls button { background:var(--accent-dark); color:white; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; font-size:14px; }
  .controls button:disabled { opacity:0.35; cursor:default; }
  .counter { position:absolute; top:12px; right:12px; background:rgba(0,0,0,0.6); color:#fff; padding:6px 10px; border-radius:6px; font-size:13px; z-index:99; }
  .sound-toggle { position:absolute; top:12px; left:12px; z-index:99; }
  .sound-toggle button { background:transparent; color:var(--accent-dark); border:1px solid #ddd; padding:6px 10px; border-radius:6px; font-size:13px; cursor:pointer; }
  .share { position:absolute; top:12px; left:120px; display:flex; gap:8px; z-index:99; }
  .share button { background:transparent; color:var(--accent-dark); border:1px solid #ddd; padding:6px 10px; border-radius:6px; font-size:13px; cursor:pointer; }
  .note { position:absolute; bottom:14px; right:14px; font-size:12px; color:var(--muted); z-index:99; }
  .cover { position:absolute; inset:0; background:linear-gradient(180deg,#f7fbf8,#f2efe9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; }
  .cover h1 { font-size:28px; margin:0 0 12px; color:var(--accent-dark); }
  .cover p { margin:6px 0 18px; color:var(--muted); }
  .cover button { background:var(--accent); color:#fff; padding:12px 20px; border:none; border-radius:8px; font-size:16px; cursor:pointer; }
  @media (max-width:700px) {
    .viewer { width:98vw; height:92vh; }
    .share { left:90px; }
    .cover h1 { font-size:20px; }
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="viewer" id="viewer" aria-live="polite">
    <div class="sound-toggle"><button id="soundBtn">üéµ Sound: ON</button></div>

    <div class="share">
      <button id="shareWhats">WhatsApp</button>
      <button id="shareLinked">LinkedIn</button>
      <button id="shareEmail">Email</button>
    </div>

    <div class="counter" id="counter">0 / 0</div>

    <div class="controls" id="controls">
      <button id="prevBtn">‚óÄ Prev</button>
      <button id="nextBtn">Next ‚ñ∂</button>
    </div>

    <div class="note">Use ‚Üê ‚Üí keys to flip. Click Start to enable music.</div>

    <div class="cover" id="cover" role="dialog" aria-label="Upahaar cover">
      <h1>Upahaar ‚Äî Corporate Gifting</h1>
      <p>Interactive catalogue ‚Äî click Start to explore (gentle ambient music plays)</p>
      <button id="startBtn">Start Flipbook ‚ñ∂</button>
    </div>

  </div>
</div>

<script>
/*
  Revised music design (marimba-like melodic + warm pad + soft pulse)
  - Synthesized only (no samples)
  - Starts on Start click
  - Sound toggle mutes/unmutes
  - Pages unchanged (80 pages)
*/

(function(){
  const viewer = document.getElementById('viewer');
  const counter = document.getElementById('counter');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const soundBtn = document.getElementById('soundBtn');
  const shareWhats = document.getElementById('shareWhats');
  const shareLinked = document.getElementById('shareLinked');
  const shareEmail = document.getElementById('shareEmail');
  const cover = document.getElementById('cover');
  const startBtn = document.getElementById('startBtn');

  const totalPages = 80;
  const pad = n => String(n).padStart(3,'0');

  let audioCtx = null;
  let masterGain = null;
  let musicRefs = null;
  let soundOn = true;

  // Create marimba-like tone using simple FM-ish approach (two oscillators + short body)
  function createMarimbaVoice(freq, time, amp=0.09, dur=1.0){
    const ctx = audioCtx;
    const now = time || ctx.currentTime;
    // carrier
    const car = ctx.createOscillator();
    car.type = 'sine';
    car.frequency.setValueAtTime(freq, now);
    // modulator ‚Äî slight FM via frequency modulation
    const mod = ctx.createOscillator();
    mod.type = 'sine';
    mod.frequency.setValueAtTime(3.5, now); // slow vibrato-ish mod
    const modGain = ctx.createGain();
    modGain.gain.setValueAtTime(freq * 0.0025, now);

    const bodyGain = ctx.createGain();
    bodyGain.gain.setValueAtTime(0.0001, now);
    bodyGain.gain.linearRampToValueAtTime(amp, now + 0.02);
    bodyGain.gain.exponentialRampToValueAtTime(0.0001, now + dur);

    // Brightness filter (to make it mallet-like)
    const bp = ctx.createBiquadFilter(); bp.type = 'bandpass'; bp.frequency.setValueAtTime(freq * 2.5, now);
    bp.Q = 6;

    // connect FM
    mod.connect(modGain);
    modGain.connect(car.frequency);
    car.connect(bp).connect(bodyGain).connect(masterGain);

    mod.start(now); car.start(now);
    car.stop(now + dur + 0.05); mod.stop(now + dur + 0.05);
  }

  function ensureAudio(){
    if(audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain();
    masterGain.gain.value = 0.9; // louder baseline but voices controlled individually
    masterGain.connect(audioCtx.destination);

    // Warm pad layer (two oscillators, gentle detune)
    const pad1 = audioCtx.createOscillator(); pad1.type='sine'; pad1.frequency.value = 110;
    const pad2 = audioCtx.createOscillator(); pad2.type='triangle'; pad2.frequency.value = 110 * 1.002;
    const g1 = audioCtx.createGain(); g1.gain.value = 0.035;
    const g2 = audioCtx.createGain(); g2.gain.value = 0.03;
    const padFilter = audioCtx.createBiquadFilter(); padFilter.type='lowpass'; padFilter.frequency.value=900;
    pad1.connect(g1); g1.connect(padFilter); pad2.connect(g2); g2.connect(padFilter); padFilter.connect(masterGain);
    pad1.start(); pad2.start();

    // gentle motion on pad filter using slow LFO
    const lfo = audioCtx.createOscillator(); lfo.type='sine'; lfo.frequency.value = 0.02;
    const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 260;
    lfo.connect(lfoGain); lfoGain.connect(padFilter.frequency);
    lfo.start();

    // Soft rhythmic pulse generator (sub + click)
    const subOsc = audioCtx.createOscillator(); subOsc.type='sine'; subOsc.frequency.value = 55;
    const subGain = audioCtx.createGain(); subGain.gain.value = 0.0001;
    subOsc.connect(subGain).connect(masterGain);
    subOsc.start();

    // Marimba arpeggio pattern (notes in a pleasant diatonic sequence)
    const sequence = [440, 392, 330, 349, 392, 440, 523, 440]; // A, G, E, F, G, A, C5, A
    let idx = 0;
    const bpm = 68;
    const stepMs = 60000 / bpm; // ms per beat
    let schedulerTime = audioCtx.currentTime + 0.1;

    function schedulePattern(){
      const lookAhead = 3.0; // seconds
      const now = audioCtx.currentTime;
      while(schedulerTime < now + lookAhead){
        // sub thump envelope
        subGain.gain.cancelScheduledValues(schedulerTime);
        subGain.gain.setValueAtTime(0.0001, schedulerTime);
        subGain.gain.linearRampToValueAtTime(0.5, schedulerTime + 0.006);
        subGain.gain.exponentialRampToValueAtTime(0.0001, schedulerTime + 0.36);

        // soft click slightly after thump (simulate mallet attack)
        playSoftClick(schedulerTime + 0.04);

        // marimba voice on some steps
        if (idx % 1 === 0) { // every step
          const note = sequence[idx % sequence.length];
          createMarimbaVoice(note, schedulerTime + 0.06, 0.08, 1.1);
        }
        idx++;
        schedulerTime += (stepMs / 1000);
      }
    }

    // click generator
    function playSoftClick(time){
      const ctx = audioCtx;
      const size = Math.floor(ctx.sampleRate * 0.04);
      const buffer = ctx.createBuffer(1, size, ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for(let i=0;i<size;i++) data[i] = (Math.random()*2-1) * Math.exp(-5*i/size);
      const src = ctx.createBufferSource(); src.buffer = buffer;
      const hf = ctx.createBiquadFilter(); hf.type='highpass'; hf.frequency.value=800;
      const g = ctx.createGain(); g.gain.setValueAtTime(0.05, time); g.gain.exponentialRampToValueAtTime(0.0001, time + 0.08);
      src.connect(hf).connect(g).connect(masterGain);
      src.start(time); src.stop(time + 0.09);
    }

    schedulePattern();
    const schedId = setInterval(schedulePattern, 900);

    // store refs so we can mute/stop gracefully later
    musicRefs = { pad1, pad2, g1, g2, padFilter, lfo, lfoGain, subOsc, subGain, schedulerTimeRef: schedulerTime, schedId };
  }

  function playFlipChime(){
    if(!audioCtx || !soundOn) return;
    const ctx = audioCtx;
    const now = ctx.currentTime;
    const o = ctx.createOscillator(); o.type='triangle'; o.frequency.value = 880;
    const g = ctx.createGain(); g.gain.setValueAtTime(0.06, now); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.4);
    o.connect(g).connect(masterGain); o.start(now); o.stop(now + 0.45);
  }

  // Sound toggle
  soundBtn.addEventListener('click', ()=>{
    if(!audioCtx) {
      try{ ensureAudio(); } catch(e){ console.log(e); }
    }
    soundOn = !soundOn;
    if(!masterGain) return;
    masterGain.gain.cancelScheduledValues(audioCtx.currentTime);
    masterGain.gain.setValueAtTime(masterGain.gain.value, audioCtx.currentTime);
    masterGain.gain.linearRampToValueAtTime(soundOn ? 0.9 : 0.0001, audioCtx.currentTime + 0.6);
    soundBtn.textContent = soundOn ? 'üéµ Sound: ON' : 'üîá Sound: OFF';
  });

  // Pages builder + navigation
  function initPages(){
    for(let i=1;i<=totalPages;i++){
      const src = `pages/page_${pad(i)}.png`;
      const el = document.createElement('div'); el.className = 'page'; el.dataset.idx = i-1;
      el.style.zIndex = 100 + (totalPages - i);
      const img = document.createElement('img'); img.src = src; img.alt = 'Page ' + i;
      el.appendChild(img);
      viewer.appendChild(el);
    }
    const pages = Array.from(document.querySelectorAll('.page'));
    let current = 0;
    function updateUI(play=true){
      pages.forEach((p,i)=>{
        if(i<current){ p.style.transform='translateX(-130%)'; p.style.opacity='0'; p.style.pointerEvents='none'; }
        else if(i===current){ p.style.transform='translateX(0)'; p.style.opacity='1'; p.style.pointerEvents='auto'; }
        else { p.style.transform='translateX(130%)'; p.style.opacity='0'; p.style.pointerEvents='none'; }
      });
      counter.textContent = (current+1) + ' / ' + pages.length;
      prevBtn.disabled = current===0; nextBtn.disabled = current===pages.length-1;
      if(play) playFlipChime();
      window.current = current;
    }
    window.showPage = function(n){
      current = Math.max(0, Math.min(pages.length-1, n));
      updateUI(true);
    };
    prevBtn.onclick = ()=> showPage((window.current||0)-1);
    nextBtn.onclick = ()=> showPage((window.current||0)+1);
    document.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') showPage((window.current||0)-1); if(e.key==='ArrowRight') showPage((window.current||0)+1); });
    // deep-link
    const pParam = parseInt(new URLSearchParams(window.location.search).get('p') || '0', 10);
    if(!isNaN(pParam) && pParam>0 && pParam<=pages.length) current = Math.max(0, Math.min(pages.length-1, pParam-1));
    updateUI(false);
  }

  // Start: init audio & pages
  startBtn.addEventListener('click', async ()=>{
    try{
      ensureAudio();
      await audioCtx.resume();
      if(masterGain) masterGain.gain.setValueAtTime(0.9, audioCtx.currentTime);
    }catch(e){ console.log('audio start err', e); }
    cover.style.display = 'none';
    initPages();
  });

  // Share buttons (deep-link current page)
  function shareUrlWithPage(){
    const base = window.location.href.split('?')[0];
    const p = (typeof window.current === 'number') ? (window.current + 1) : 1;
    return base + '?p=' + p;
  }
  shareWhats.addEventListener('click', ()=>{ window.open('https://api.whatsapp.com/send?text=' + encodeURIComponent('Flip through Upahaar catalogue: ' + shareUrlWithPage()), '_blank'); });
  shareLinked.addEventListener('click', ()=>{ window.open('https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(shareUrlWithPage()), '_blank'); });
  shareEmail.addEventListener('click', ()=>{ window.location.href = 'mailto:?subject=' + encodeURIComponent('Upahaar Catalogue') + '&body=' + encodeURIComponent('Hi ‚Äî check this Upahaar catalogue: ' + shareUrlWithPage()); });

})();
</script>
</body>
</html>
